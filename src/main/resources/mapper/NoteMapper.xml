<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.ybook.mapper.NoteMapper">

    <!-- 笔记实体结果映射 -->
    <resultMap id="noteResultMap" type="com.example.ybook.entity.NoteEntity">
        <id column="id" property="id"/>
        <result column="uid" property="uid"/>
        <result column="title" property="title"/>
        <result column="content" property="content"/>
        <result column="images" property="images" 
                typeHandler="com.baomidou.mybatisplus.extension.handlers.JacksonTypeHandler"/>
        <result column="video" property="video"/>
        <result column="view_count" property="viewCount"/>
        <result column="like_count" property="likeCount"/>
        <result column="comment_count" property="commentCount"/>
        <result column="collect_count" property="collectCount"/>
        <result column="is_top" property="isTop"/>
        <result column="type" property="type"/>
        <result column="ip_location" property="ipLocation"/>
        <result column="create_time" property="createTime"/>
        <result column="update_time" property="updateTime"/>
    </resultMap>

    <!-- 根据用户ID查询笔记列表 -->
    <select id="selectByUserId" resultMap="noteResultMap">
        SELECT * FROM y_note 
        WHERE uid = #{userId} 
        ORDER BY is_top DESC, update_time DESC
    </select>

    <!-- 根据用户ID分页查询笔记 -->
    <select id="selectPageByUserId" resultMap="noteResultMap">
        SELECT * FROM y_note 
        WHERE uid = #{userId} 
        ORDER BY is_top DESC, update_time DESC
    </select>

    <!-- 根据标签ID查询笔记列表 -->
    <select id="selectByLabelId" resultMap="noteResultMap">
        SELECT n.* FROM y_note n
        INNER JOIN y_note_label nl ON n.id = nl.note_id
        WHERE nl.label_id = #{labelId} AND n.uid = #{userId}
        ORDER BY n.is_top DESC, n.update_time DESC
    </select>

    <!-- 根据标签ID分页查询笔记 -->
    <select id="selectPageByLabelId" resultMap="noteResultMap">
        SELECT n.* FROM y_note n
        INNER JOIN y_note_label nl ON n.id = nl.note_id
        WHERE nl.label_id = #{labelId} AND n.uid = #{userId}
        ORDER BY n.is_top DESC, n.update_time DESC
    </select>

    <!-- 根据关键词搜索笔记 -->
    <select id="searchNotes" resultMap="noteResultMap">
        SELECT * FROM y_note
        WHERE uid = #{userId}
        AND (title LIKE CONCAT('%', #{keyword}, '%') OR content LIKE CONCAT('%', #{keyword}, '%'))
        ORDER BY is_top DESC, update_time DESC
    </select>

</mapper>