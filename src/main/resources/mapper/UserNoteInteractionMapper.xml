<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.ybook.mapper.UserNoteInteractionMapper">

    <!-- 根据用户ID和笔记ID查询交互记录 -->
    <select id="selectByUserIdAndNoteId" resultType="com.example.ybook.entity.UserNoteInteractionEntity">
        SELECT id, user_id, note_id, interaction_type, create_time, update_time
        FROM y_user_note_interaction
        WHERE user_id = #{userId} AND note_id = #{noteId}
    </select>

    <!-- 批量查询用户对多个笔记的交互状态 -->
    <select id="selectBatchByUserIdAndNoteIds" resultType="com.example.ybook.entity.UserNoteInteractionEntity">
        SELECT id, user_id, note_id, interaction_type, create_time, update_time
        FROM y_user_note_interaction
        WHERE user_id = #{userId} AND note_id IN
        <foreach collection="noteIds" item="noteId" open="(" close=")" separator=",">
            #{noteId}
        </foreach>
    </select>

    <!-- 查询用户收藏的笔记ID列表（分页） -->
    <select id="selectFavoriteNoteIdsByUserId" resultType="java.lang.Long">
        SELECT note_id
        FROM y_user_note_interaction
        WHERE user_id = #{userId} AND (interaction_type &amp; 2) > 0
        ORDER BY update_time DESC
    </select>

    <!-- 查询用户点赞的笔记ID列表（分页） -->
    <select id="selectLikedNoteIdsByUserId" resultType="java.lang.Long">
        SELECT note_id
        FROM y_user_note_interaction
        WHERE user_id = #{userId} AND (interaction_type &amp; 1) > 0
        ORDER BY update_time DESC
    </select>

    <!-- 统计笔记的点赞数 -->
    <select id="countLikesByNoteId" resultType="java.lang.Long">
        SELECT COUNT(1)
        FROM y_user_note_interaction
        WHERE note_id = #{noteId} AND (interaction_type &amp; 1) > 0
    </select>

    <!-- 统计笔记的收藏数 -->
    <select id="countFavoritesByNoteId" resultType="java.lang.Long">
        SELECT COUNT(1)
        FROM y_user_note_interaction
        WHERE note_id = #{noteId} AND (interaction_type &amp; 2) > 0
    </select>

    <!-- 批量统计多个笔记的点赞数和收藏数 -->
    <select id="selectInteractionCountsByNoteIds" resultType="java.util.Map">
        SELECT 
            note_id as noteId,
            SUM(CASE WHEN (interaction_type &amp; 1) > 0 THEN 1 ELSE 0 END) as likeCount,
            SUM(CASE WHEN (interaction_type &amp; 2) > 0 THEN 1 ELSE 0 END) as favoriteCount
        FROM y_user_note_interaction
        WHERE note_id IN
        <foreach collection="noteIds" item="noteId" open="(" close=")" separator=",">
            #{noteId}
        </foreach>
        GROUP BY note_id
    </select>

    <!-- 根据笔记ID删除所有相关的交互记录 -->
    <delete id="deleteByNoteId">
        DELETE FROM y_user_note_interaction 
        WHERE note_id = #{noteId}
    </delete>

</mapper>